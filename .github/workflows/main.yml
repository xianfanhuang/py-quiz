name: Build Pyodide & Deploy to GitHub Pages

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: 拉取代码
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 使用Docker容器进行构建
      - name: 构建自定义 Pyodide
        run: |
          # 创建非交互式安装脚本
          cat > build.sh << 'EOL'
          #!/bin/bash
          set -ex
          
          # 设置非交互式环境
          export DEBIAN_FRONTEND=noninteractive
          export TZ=Asia/Shanghai
          
          # 安装依赖
          apt-get update
          apt-get install -y --no-install-recommends \
              software-properties-common \
              build-essential \
              cmake \
              nodejs \
              npm \
              git \
              curl \
              make \
              g++
          
          # 添加Python PPA
          add-apt-repository -y ppa:deadsnakes/ppa
          
          # 自动安装Python 3.11（跳过时区配置）
          apt-get install -y --no-install-recommends \
              python3.11 \
              python3.11-dev \
              python3.11-venv \
              tzdata
          
          # 设置默认时区
          ln -fs /usr/share/zoneinfo/Asia/Shanghai /etc/localtime
          dpkg-reconfigure --frontend noninteractive tzdata
          
          # 继续构建...
          python3.11 -m venv /venv
          source /venv/bin/activate
          pip install pyodide-build==0.25.0
          pyodide build --output-dir ./dist/static/pyodide --meta-yaml-path ./pyodide_meta.yaml
          chmod -R 777 ./dist
          EOL

      - name: 部署到 GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./dist

permissions:
  contents: write
  pages: write

concurrency:
  group: github-pages
  cancel-in-progress: true